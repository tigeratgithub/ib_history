# Repository Guidelines

## 概览
本仓库用于获取 MNQ 与 MGC 的历史 K 线数据，补足 IBKR 无法按连续主力合约分段拉取的问题，主要面向回测使用。目前代码结构尚未建立，贡献时请同步更新 README 说明新增模块与用法。

## 项目结构与模块组织
- 项目中需要用到的2个开源项目已经下载到根目录中

  ib_async

  lightweight-charts-python

  相关使用方法你可以查看目录中的代码和文档

## 构建、测试与本地开发命令

1. 使用python开发

  使用uv管理python虚拟环境，虚拟环境为根目录下.venv

2. 使用ib_async库通过本地ib_gateway获取各MNQ和MGC的期货数据
  如每年的几个期货成为主力的时间区段
  时间使用UTC，显示时间使用纽约时区，注意节假日，夏令时
  对于获取失败的需要区分真的失败如服务器拒绝，获取超时等和节假日获取不到数据的区别，正真的获取失败需要写入数据库日志表
  对于第一次获取失败的数据在第一遍获取结束后重新获取失败的时间段。结束后再对失败的重新获取一边，总共三轮。最终还是失败的写入数据库日志表

3. 使用sqlite3保存数据
  获取不同标的的不同周期的K线数据存入不同的数据表中，对于获取失败的标的周期及时间段写入日志数据表，成功的不用保存。注意区分真正的获取数据失败和没有数据可获取的区别（如节假日）

4. 工具使用：
  1. 用户可以通过指定标的集合，周期集合，起始时间，结束时间 获取数据
  2. 也可以通过指定定标的集合，周期集合，距最近的时间区段（如 最近2个月或者最近3年）
  3. 程序执行完后需要报告获取数据简报，如获取时间段，K线数据量，失败区段列表等
  4. 数据获取执行完毕，使用lightweight-charts-python进行数据显示，lightweight-charts-python可以使用动态加载数据，以避免一次性加载太多数据
  5. 使用 lightweight-charts-python的显示程序可以选择标的，周期，时间点

5. 注意的点，因为盈透对于数据获取有时间间隔限制，以及一次性获取数据量的限制，所以要进行时间分片获取数据，具体限制你可以搜索ibkr api的相关文档

6. 测试方案及用例你根据上面要求来制定

7. 最终的程序以python库的方式递交

## 当前进展（简要）
- 已实现数据获取与落库：按**单月合约分段**拉取 MNQ/MGC 的 3m/15m 数据，写入 `data/ib_history.sqlite`
- 已实现图表查看器：基于 `lightweight-charts-python`，支持标的/周期切换与动态加载
- 图表启动脚本：`run_chart.ps1`（已包含 `PYTHONPATH`）
- 正在排查：**K线悬浮详情（结束时间/时区/C‑O）未显示**，已添加启动/回调日志用于定位

## 常用命令
```powershell
# 图表查看器
.\run_chart.ps1
```

## 已确认的实现决策（请保持同步）
1. **交付形式**：Python 库 + CLI 入口。
2. **配置**：`config.py` 采用 Python 配置模块（`dataclass` + 默认值），CLI/函数参数覆盖。
3. **SQLite 结构**：每标的每周期一表（`bars_{symbol}_{bar}`），并创建失败日志表 `fetch_failures`。
4. **失败重试**：三轮重试；区分无数据与真实失败，真实失败写日志表。
5. **滚动主力近似规则（默认）**：
   - MNQ：到期月第三个周五前的周一滚动（≈提前 4–5 交易日）
   - MGC：到期月前一月月底前 2 个交易日滚动
6. **报告**：控制台摘要 + JSON 报告文件。
7. **图表**：实现完整交互式查看器（标的/周期选择 + 动态加载）。

   





